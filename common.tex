\usepackage{xparse}
\usepackage{xcolor}
\usepackage{marginnote}
\usepackage{ifthen}
\usepackage{calc}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{mathrsfs}
\usepackage{nicefrac}
\usepackage{sectsty}
\usepackage{hyperref} % <- should be last because it redefined \ref, etc..

\newcommand{\IGNORE}[1]{}

% macros concerning textstyle
\colorlet{darkblue}{blue!75!black}
\colorlet{lightblue}{blue!50!white}
\colorlet{lightgray}{gray!50!white}
\colorlet{darkgray}{gray!75!black}
\colorlet{darkred}{red!75!black}

\allsectionsfont{\sffamily\color{darkblue}}

\newcommand{\textPointHeaderI}[1]{\textcolor{darkblue}{\textbf{\textsf{#1}}}}
\newcommand{\textPointHeaderII}[1]{\textcolor{darkblue}{\textsf{#1}}}
\newcommand{\textPointHeaderIII}[1]{\textcolor{lightgray}{\textsf{#1}}}
\newcommand{\textParsecNumber}[1]{\textcolor{darkblue}{\textbf{\textsf{#1}}}}
\newcommand{\textPointNumberI}[1]{\textcolor{darkblue}{\textsf{#1}}}
\newcommand{\textPointNumberII}[1]{\textcolor{lightblue}{\textsf{#1}}}
\newcommand{\textPointNumberIII}[1]{\textcolor{lightgray}{\textsf{#1}}}
\newcommand{\textDefine}[1]{\textcolor{darkblue}{#1}}
\newcommand{\textSref}[1]{\textsf{#1}}
\newcommand{\textTodo}[1]{\textcolor{darkred}{#1}}

\newcommand{\TODO}[1]{\textTodo{\textbf{TODO}:\ #1}}
\newcommand{\define}[1]{\textDefine{#1}}
\newcommand{\grayed}[1]{\textcolor{darkgray}{#1}}





% Common symbols
\newcommand{\C}{\mathbb{C}}
\newcommand{\R}{\mathbb{R}}
\newcommand{\spec}{\mathrm{sp}}
\newcommand{\scrA}{\mathscr{A}}
\newcommand{\scrB}{\mathscr{B}}
\newcommand{\scrC}{\mathscr{C}}
\newcommand{\scrH}{\mathscr{H}}

\newcommand{\ceil}[1]{\left\lceil#1\right\rceil}
\newcommand{\floor}[1]{\left\lfloor#1\right\rfloor}

\newcommand{\sa}[1]{#1_{\R}}

\DeclareMathOperator{\dom}{dom}


% typesetting theorems
\newcommand{\qed}{\hfill\textcolor{darkblue}{\ensuremath{\square}}}


\newcounter{tmp} % used for arithmetic

% The content of this thesis is grouped into numbered paragraphs,
% which are called "parsecs" (for paragraph--section),
% and these parsecs contain several points.
\newcounter{parsec} % keeps track of the current parsec number

% The first argument is the label this parsec will have--use \sref 
% 	to refer to a parsec.
\NewDocumentEnvironment{parsec}{o}{%
	\par\penalty-200\vskip1em\noindent%
	\refstepcounter{parsec}%
	%%\setcounter{point}{0}% - point is set to 0 by \numberwithin
	% In the footer of every odd page we list the parsecs present on 
	% the spread.  We pass this information to the footer via the 
	% \markboth,\leftmark,\rightmark-mechanism, which is normally
	% used to display the section and subsection names and numbers
	% in the header.
	% 	Recall that \leftmark will return the LAST value passed
	% to the first argument of \markboth on this page. (The difficulty
	% of implementing \leftmark is that a \markboth that will belong
	% to the next page can be called before the current page is shipped,
	% because this \markboth may be part of the text that overflows the
	% current page.)
	%	\rightmark will return the FIRST value passed to the second
	% argument of \markboth on this page.
	%	Since we would not only like to know if this parsec with number
	% say  N  is present on this spread, but also whether it spills over 
	% to the next spread (or has spilled over from the previous spread),
	% we keep track of whether the parsec started on this spread, 
	% encoded by  2N,  or whether the parsec ended on this spread,
	% encoded by  2N+1.
	\setcounter{tmp}{2*\value{parsec}}%
	\markboth{\the\value{tmp}}{\the\value{tmp}}%
	\label{#1}%
	% Display the parsec number in the margin.
	\marginnote{\makebox[3em][c]{\textParsecNumber{\the\value{parsec}}}}%
}{%
	\setcounter{tmp}{2*\value{parsec}+1}%
	\markboth{\the\value{tmp}}{\the\value{tmp}}%
}

\newcounter{point} % keeps track of the current point
\numberwithin{point}{parsec}
\renewcommand{\thepoint}{\theparsec\,\Roman{point}}
\newcounter{pointdepth}  % keeps track of the depth of the current point
			 % --- points may be nested.

\NewDocumentEnvironment{point}{o g}{%
	\setcounter{pointdepth}{\value{pointdepth}+1}%
	\refstepcounter{point}%
	\IfValueT{#1}{\label{#1}}%
	\ifthenelse{\equal{\value{point}}{1}}{}{%
		\par\penalty-100\vskip.3em\noindent%
		\marginnote{\makebox[1em][c]{%
			\ifthenelse{\equal{\value{pointdepth}}{1}}{%
				\textPointNumberI{\Roman{point}}%
			}{%
				\ifthenelse{\equal{\value{pointdepth}}{2}}{%
					\textPointNumberII{\Roman{point}}%
				}{%
					\textPointNumberIII{\Roman{point}}%
				}%
		}}}%
	}%
	\IfValueT{#2}{%
		\ifthenelse{\equal{\value{pointdepth}}{1}}{%
			\textPointHeaderI{#2}%
		}{%
			\ifthenelse{\equal{\value{pointdepth}}{2}}{%
				\textPointHeaderII{#2}%
			}{%
				\textPointHeaderIII{#2}%
			}}%
	\ \ }%	
}{%
\setcounter{pointdepth}{\value{pointdepth}-1}%
}

% Refer to a parsec.
\NewDocumentCommand{\sref}{m}{\textSref{\ref{#1}}}

% Adjust footer and header:
\usepackage{fancyhdr}
\pagestyle{fancy}
\renewcommand{\headrulewidth}{0pt} % we want no header line

% Since we use \markboth,\leftmark,\rightmark to keep track of the parsecs
% on a given spread, we should neutralize its old user:
\renewcommand{\chaptermark}[1]{}  
\renewcommand{\sectionmark}[1]{}

\fancyhead{}

% These counters are used for computation
\newcounter{firstParsec}
\newcounter{lastParsec}
\newcounter{firstParsecF}
\newcounter{lastParsecF}

% parsecToBeContinued is 1 if the previous spread spilled a parsec,
% and 0 otherwise.
\newcounter{parsecToBeContinued}  
\setcounter{parsecToBeContinued}{0}

% Set the footer.  It contains the parsecs on this page.
% We use "\rightmark+0", because \rightmark might be empty.
\fancyfoot[CE]{\setcounter{firstParsecF}{\rightmark+0}}
\fancyfoot[CO]{%
% firstParsecF is already set by the even page that came before
\setcounter{firstParsec}{\value{firstParsecF}/2}%
\setcounter{lastParsecF}{\leftmark+0}%
\ifthenelse{\equal{\value{lastParsecF}}{0}}%
{}% do nothing
{%
\setcounter{lastParsec}{\value{lastParsecF}/2}%
\textPointNumberI{%
\ifthenelse{\equal{\value{parsecToBeContinued}}{1}}{..}{}%
\the\value{firstParsec}%
\ifthenelse{\equal{\value{firstParsec}}{\value{lastParsec}}}%
	{}{%  no footer without parsecs
\setcounter{tmp}{\value{firstParsec}+1}%
\ifthenelse{\equal{\value{tmp}}{\value{lastParsec}}}{, }{--}%
\the\value{lastParsec}}%
\setcounter{tmp}{\value{lastParsec}*2}%
\ifthenelse{\equal{\value{tmp}}{\value{lastParsecF}}}%
{..\setcounter{parsecToBeContinued}{1}}%
{\setcounter{parsecToBeContinued}{0}}%
}% \textPointNumberI{
}% \ifthenelse{
}% \fancyfoot[CO]{

