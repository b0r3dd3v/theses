\usepackage{cite}
\usepackage{makeidx}
\usepackage{xparse}
\usepackage{relsize}
\usepackage{bussproofs}
\usepackage{xcolor}
\usepackage{graphicx}
\usepackage{makeidx}
\usepackage{xstring}
\usepackage{braket}
\usepackage{mathtools}
\usepackage{multicol}
\usepackage{marginnote}
\usepackage{ifthen}
\usepackage{xifthen}
\usepackage{paralist}
\usepackage{calc}
\usepackage{tikz}
\usepackage{tikz-cd}
\usetikzlibrary{calc,arrows,matrix}
\usepackage{picins}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{mathrsfs}
\usepackage{nicefrac}
\usepackage{stmaryrd}
\usepackage{sectsty}
\usepackage{xr}
\usepackage{tikz}
\usepackage[all]{xypic}
\usepackage{hyperref} % <- should be last because it redefined \ref, etc..

\renewcommand{\thefootnote}{\fnsymbol{footnote}}


\newcommand{\IGNORE}[1]{}

% macros concerning textstyle
\colorlet{darkgreen}{green!50!black}
\colorlet{darkblue}{blue!75!black}
\colorlet{lightblue}{blue!50!white}
\colorlet{lightgray}{gray!50!white}
\colorlet{darkgray}{gray!75!black}
\colorlet{darkred}{red!75!black}

\allsectionsfont{\sffamily\color{darkblue}}

\newcommand{\textPointHeaderI}[1]{\textcolor{darkblue}{\textbf{\textsf{#1}}}}
\newcommand{\textPointHeaderII}[1]{\textcolor{darkblue}{\textsf{#1}}}
\newcommand{\textPointHeaderIII}[1]{\textcolor{lightgray}{\textsf{#1}}}
\newcommand{\textParsecNumber}[1]{\textcolor{darkblue}{\textbf{\textsf{#1}}}}
\newcommand{\textPointNumberI}[1]{\textcolor{darkblue}{\textsf{#1}}}
\newcommand{\textPointNumberII}[1]{\textcolor{lightblue}{\textsf{#1}}}
\newcommand{\textPointNumberIII}[1]{\textcolor{lightgray}{\textsf{#1}}}
\newcommand{\textDefine}[1]{\textcolor{darkblue}{#1}}
\newcommand{\textSref}[1]{\textsf{#1}}
\newcommand{\textTodo}[1]{\textcolor{darkred}{#1}}
\newcommand{\textRemark}[1]{\textcolor{purple}{#1}}

\newcommand{\TODO}[1]{\textTodo{\textbf{TODO}:\ #1}}
\newcommand{\REMARK}[1]{\textRemark{\textbf{[} #1 \textbf{]}}}
\newcommand{\Define}[1]{\textDefine{#1}}

\newcommand{\grayed}[1]{\textcolor{darkgray}{#1}}

\renewcommand{\leq}{\leqslant}
\renewcommand{\geq}{\geqslant}
\renewcommand{\nleq}{\not\leqslant}
\renewcommand{\ngeq}{\not\geqslant}

\newcommand{\Cat}[1]{\mathbf{#1}}
\newcommand{\cW}[1]{\Cat{cW}^*_{\text{\textsc{#1}}}}
\newcommand{\W}[1]{\Cat{W}^*_{\text{\textsc{#1}}}}
\newcommand{\dW}[1]{\Cat{dW}^*_{\text{\textsc{#1}}}}
\newcommand{\cCstar}[1]{\Cat{cC}^*_{\text{\textsc{#1}}}}
\newcommand{\Cstar}[1]{\Cat{C}^*_{\text{\textsc{#1}}}}
\newcommand{\CH}{\Cat{CH}}
\newcommand{\op}[1]{{#1}{^{\mathsf{op}}}}

\newcommand{\ketbra}[2]{\left|#1\right>\!\left<#2\right|}
\newcommand{\uleq}{\mathbin{\rotatebox[origin=c]{90}{$\leq$}}}
\newcommand{\TR}{\mathop{\mathrm{tr}}}
\newcommand{\wn}{\mathop{\mathrm{wn}}}

\newcommand{\bsp}{\scrB}

\NewDocumentCommand{\vmleq}{o}{\mathrel{%
\IfNoValueTF{#1}{\lesssim}{\lesssim_{#1}}}}

% Common symbols
\newcommand{\C}{\mathbb{C}}
\newcommand{\N}{\mathbb{N}}
\newcommand{\Z}{\mathbb{Z}}
\newcommand{\R}{\mathbb{R}}
\newcommand{\I}{\mathbb{I}}
\newcommand{\spec}{\mathrm{sp}}
\newcommand{\scrA}{\mathscr{A}}
\newcommand{\scrB}{\mathscr{B}}
\newcommand{\scrC}{\mathscr{C}}
\newcommand{\scrD}{\mathscr{D}}
\newcommand{\scrE}{\mathscr{E}}
\newcommand{\scrG}{\mathscr{G}}
\newcommand{\scrH}{\mathscr{H}}
\newcommand{\scrF}{\mathscr{F}}
\newcommand{\scrP}{\mathscr{P}}
\newcommand{\scrK}{\mathscr{K}}
\newcommand{\scrL}{\mathscr{L}}
\newcommand{\scrR}{\mathscr{R}}
\newcommand{\scrS}{\mathscr{S}}
\newcommand{\scrT}{\mathscr{T}}
\newcommand{\scrX}{\mathscr{X}}
\newcommand{\scrY}{\mathscr{Y}}
\newcommand{\scrZ}{\mathscr{Z}}

\newcommand{\ceil}[1]{\left\lceil#1\right\rceil}
\newcommand{\cceil}[1]{\left\lceil\!\!\left\lceil#1\right\rceil\!\!\right\rceil}
\newcommand{\cfloor}[1]{\left\lfloor\!\!\left\lfloor#1\right\rfloor\!\!\right\rfloor}
\newcommand{\floor}[1]{\left\lfloor#1\right\rfloor}
\newcommand{\ceill}[1]{\left\lceil#1\right)}
\newcommand{\ceilr}[1]{\left(#1\right\rceil}
\newcommand{\floorl}[1]{\left\lfloor#1\right)}
\newcommand{\floorr}[1]{\left(#1\right\rfloor}
\newcommand{\absl}[1]{\left|#1\right)}
\newcommand{\absr}[1]{\left(#1\right|}

\newcommand{\linf}{\ell^\infty}
\newcommand{\incfun}{\mathcal{J}}
\newcommand{\limp}{\mathbin{\multimap}}
\newcommand{\Mon}{\mathrm{Mon}}
\newcommand{\CMon}{\mathrm{cMon}}
\newcommand{\nsp}{\mathrm{nsp}}
\newcommand{\qbit}{\mathsf{qbit}}
\newcommand{\bit}{\mathsf{bit}}
\DeclarePairedDelimiter{\sem}{\llbracket}{\rrbracket}

\newcommand{\Real}[1]{#1_{\R}}
\newcommand{\Imag}[1]{#1_{\I}}
\newcommand{\sa}[1]{#1_{\R}}
\newcommand{\pos}[1]{#1_{+}}
\newcommand{\bang}{\mathord{!}}

\newcommand\T{\mathrm{t}} % for transpose

\DeclareMathOperator{\dom}{dom}
\DeclareMathOperator{\length}{length}
\DeclareMathOperator{\interior}{in}
\DeclareMathOperator{\Stat}{Stat}
\DeclareMathOperator{\Pred}{Pred}
\DeclareMathOperator{\Pure}{Pure}
\DeclareMathOperator{\SPred}{SPred}
\DeclareMathOperator{\IM}{im}
\newcommand\BOX{{\rlap{\rotatebox[origin=c]{45}{$\diamond$}}\phantom{\diamond}}}
\DeclareMathOperator{\IMperp}{im^\perp}
\DeclareMathOperator{\cok}{cok}
\DeclareMathOperator{\Par}{Par}
\DeclareMathOperator{\Tot}{Tot}
\newcommand{\andthen}[2]{#1 \mathbin{\&} #2}
\newcommand\asrt{\mathrm{asrt}}
\newcommand\sef{\mathrm{seff}}
\newcommand\pproj{\mathord{\vartriangleright}}
\newcommand{\cmpr}[2]{\ensuremath{\{#1|{\kern.2ex}#2\}}}
\DeclareMathOperator{\NStat}{NStat}
\DeclareMathOperator{\Scal}{Scal}
\DeclareMathOperator{\Cont}{C}
\DeclareMathOperator{\Colim}{Colim}
\DeclareMathOperator{\id}{id}
\DeclareMathOperator{\hZ}{hZ}
\DeclareMathOperator{\Inv}{Inv}
\DeclareMathOperator{\Proj}{Proj}
\DeclareMathOperator{\supp}{supp}
\DeclareMathOperator{\Ker}{Ker}
\DeclareMathOperator{\Ran}{Ran}
\DeclareMathOperator{\Nsb}{Nsb}
\newenvironment{spmatrix}{%
    \left(\begin{smallmatrix}}{%
    \end{smallmatrix}\right)}

\newcommand\after{\mathop{\circ}}
\newcommand\hafter{\mathop{\hat\circ}}
\newcommand\hotimes{\mathbin{\hat{\otimes}}}
\newcommand\ad{\mathrm{ad}}
\newcommand{\uwlim}{\qopname\relax m{uwlim}}
\newcommand{\unlim}{\qopname\relax m{unlim}}
\newcommand{\uslim}{\qopname\relax m{uslim}}
\newcommand\concat{\mathbin{\raisebox{1ex}{\scalebox{.7}{$\frown$}}}}
\newcommand\ncp{\mathrm{ncp}}
\newcommand\pto{\rightharpoonup}
\newcommand\pfrom{\leftharpoonup}
\newcommand{\pullback}[1][dr]{\save*!/#1-1.2pc/#1:(-1,1)@^{|-}\restore}
\newcommand\vN{\mathsf{vN}}
\newcommand\AConvM{\mathsf{AConv}_M}
\newcommand\EMod{\mathsf{EMod}}
\newcommand{\bigovee}{\mathop{\vphantom{\sum}\mathchoice%
        {\vcenter{\hbox{\huge $\ovee$}}}%
        {\vcenter{\hbox{\Large $\ovee$}}}%
        {\ovee}{\ovee}}\displaylimits}
\DeclareMathOperator{\Kl}{\mathcal{K}\!\ell}
\newcommand\rfrac[2]{\reflectbox{\nicefrac{\reflectbox{\ensuremath{#1}}}{\reflectbox{\ensuremath{#2}}}}}

% number a single equation in an align*
% http://tex.stackexchange.com/questions/42726/
\newcommand\numberthis{\addtocounter{equation}{1}\tag{\theequation}}

% typesetting theorems
\newcommand{\qed}{\hfill\textcolor{darkblue}{\ensuremath{\square}}}


\newcounter{tmptmp} % used for arithmetic

% The content of this thesis is grouped into numbered paragraphs,
% which are called "parsecs" (for paragraph--section),
% and these parsecs contain several points.
\newcounter{parsec} % keeps track of the current parsec number

% The first argument is the label this parsec will have--use \sref 
% 	to refer to a parsec.
\NewDocumentEnvironment{parsec}{o}{%
	\leavevmode\unskip%
	\par\penalty-200\vskip1em\noindent%
	\refstepcounter{parsec}%
	%%\setcounter{point}{0}% - point is set to 0 by \numberwithin
	% In the footer of every odd page we list the parsecs present on 
	% the spread.  We pass this information to the footer via the 
	% \markboth,\leftmark,\rightmark-mechanism, which is normally
	% used to display the section and subsection names and numbers
	% in the header.
	% 	Recall that \leftmark will return the LAST value passed
	% to the first argument of \markboth on this page. (The difficulty
	% of implementing \leftmark is that a \markboth that will belong
	% to the next page can be called before the current page is shipped,
	% because this \markboth may be part of the text that overflows the
	% current page.)
	%	\rightmark will return the FIRST value passed to the second
	% argument of \markboth on this page.
	%	Since we would not only like to know if this parsec with number
	% say  N  is present on this spread, but also whether it spills over 
	% to the next spread (or has spilled over from the previous spread),
	% we keep track of whether the parsec started on this spread, 
	% encoded by  2N,  or whether the parsec ended on this spread,
	% encoded by  2N+1.
	\setcounter{tmptmp}{2*\value{parsec}}%
	\markboth{\the\value{tmptmp}}{\the\value{tmptmp}}%
	\IfValueT{#1}{\label{#1}}%
	% Display the parsec number in the margin.
	\marginnote{\makebox[3em][c]{\textParsecNumber{\the\value{parsec}}}}%
	\ignorespaces%
}{%
	\leavevmode\unskip%
	\setcounter{tmptmp}{2*\value{parsec}+1}%
	\markboth{\the\value{tmptmp}}{\the\value{tmptmp}}%
	\ignorespaces%
}

\newcounter{point} % keeps track of the current point
\numberwithin{point}{parsec}
\newcounter{pointdepth}  % keeps track of the depth of the current point
			 % --- points may be nested.


\NewDocumentEnvironment{point}{o g}{%
	\leavevmode\unskip%
	\setcounter{pointdepth}{\value{pointdepth}+1}%
	\refstepcounter{point}%
	\IfValueT{#1}{%
		\renewcommand{\thepoint}{\the\value{parsec}}%
		\setcounter{point}{\value{point}-1}%
		\refstepcounter{point}%
		\label{#1::parsec}%
		\renewcommand{\thepoint}{\Roman{point}}%
		\setcounter{point}{\value{point}-1}%
		\refstepcounter{point}%
		\label{#1::point}%
		\renewcommand{\thepoint}{\theparsec\,\Roman{point}}%
		\setcounter{point}{\value{point}-1}%
		\refstepcounter{point}%
		\label{#1}%
	}%
    \renewcommand{\thepoint}{\theparsec\,\Roman{point}}%
    \setcounter{point}{\value{point}-1}%
    \refstepcounter{point}%
    \label{parsec-\the\value{parsec}.\the\value{point}}%
	\ifthenelse{\equal{\value{point}}{1}}{}{%
		\ifthenelse{\equal{\value{pointdepth}}{1}}{%
			\par\penalty-100\vskip.5em\noindent%
		}{%
			\ifthenelse{\equal{\value{pointdepth}}{2}}{%
				\par\penalty-50\vskip.3em\noindent%
			}{%
				\par\penalty-25\vskip.2em\noindent%
			}%
		}%
		\marginnote{\makebox[2em][c]{\small%
			\ifthenelse{\equal{\value{pointdepth}}{1}}{%
				\textPointNumberI{\Roman{point}}%
			}{%
				\ifthenelse{\equal{\value{pointdepth}}{2}}{%
					\textPointNumberII{\Roman{point}}%
				}{%
					\textPointNumberIII{\Roman{point}}%
				}%
		}}}%
	}%
	\IfValueT{#2}{%
		\ifthenelse{\equal{\value{pointdepth}}{1}}{%
			\textPointHeaderI{#2}%
		}{%
			\ifthenelse{\equal{\value{pointdepth}}{2}}{%
				\textPointHeaderII{#2}%
			}{%
				\textPointHeaderIII{(#2)}%
			}}%
	\ \ }%	
\ignorespaces%
}{%
\leavevmode\unskip%
\setcounter{pointdepth}{\value{pointdepth}-1}%
\ignorespaces%
}

% Refer to a parsec.
\NewDocumentCommand{\sref}{m}{\textSref{%
	\ifthenelse{%
		\equal{\value{parsec}}{\ref{#1::parsec}}%
	}{%
		\ref{#1::point}%
	}{%
		\ref{#1}%
	}%
}}

% Adjust footer and header:
\usepackage{fancyhdr}
\pagestyle{fancy}
\renewcommand{\headrulewidth}{0pt} % we want no header line

% Since we use \markboth,\leftmark,\rightmark to keep track of the parsecs
% on a given spread, we should neutralize its old user:
\renewcommand{\chaptermark}[1]{}  
\renewcommand{\sectionmark}[1]{}

\fancyhead{}

% These counters are used for computation
\newcounter{firstParsec}
\newcounter{lastParsec}
\newcounter{firstParsecF}
\newcounter{lastParsecF}

% parsecToBeContinued is 1 if the previous spread spilled a parsec,
% and 0 otherwise.
\newcounter{parsecToBeContinued}  
\setcounter{parsecToBeContinued}{0}

% Set the footer.  It contains the parsecs on this page.
% We use "\rightmark+0", because \rightmark might be empty.
\fancyfoot[CE]{%
    \IfInteger{\rightmark}{%
        \setcounter{firstParsecF}{\rightmark+0}%
    }{%
        \setcounter{firstParsecF}{1337}% TODO remove
    }%
}

\fancyfoot[CO]{%
    % firstParsecF is already set by the even page that came before
    \setcounter{firstParsec}{\value{firstParsecF}/2}%
    \setcounter{lastParsecF}{\leftmark+0}%
    \ifthenelse{\equal{\value{lastParsecF}}{0}}{%
        % do nothing
    }{%
        \setcounter{lastParsec}{\value{lastParsecF}/2}%
        \textPointNumberI{%
            \ifthenelse{\equal{\value{parsecToBeContinued}}{1}}{..}{}%
            \the\value{firstParsec}%
            \ifthenelse{\equal{\value{firstParsec}}{\value{lastParsec}}}{%
                % TODO
            }{%  no footer without parsecs
                \setcounter{tmptmp}{\value{firstParsec}+1}%
                \ifthenelse{\equal{\value{tmptmp}}{\value{lastParsec}}}{, }{--}%
                \the\value{lastParsec}%
            }%
            \setcounter{tmptmp}{\value{lastParsec}*2}%
            \ifthenelse{\equal{\value{tmptmp}}{\value{lastParsecF}}}{%
                ..\setcounter{parsecToBeContinued}{1}%
            }{%
                \setcounter{parsecToBeContinued}{0}%
            }%
        }%
    }%
}%

% Index support for parsecs
\def\parsechyperlink#1{\sref{parsec-#1}}
\makeatletter
\def\@wrindex#1{%
   \protected@write\@indexfile{}%
   {\string\indexentry{#1|parsechyperlink{\the\value{parsec}.\the\value{point}}}{\the\value{parsec}.\the\value{point}}}%
 \endgroup
 \@esphack}%
\makeatother


% TOC support for parsecs
\let\oldchapter\chapter%
\renewcommand\chapter[1]{%
    \setcounter{firstParsec}{\value{firstParsecF}/2+1}%
    \addtocontents{parsectoc}{\protect\contentsline{chapter}{#1}{\sref{parsec-\the\value{firstParsec}.1}}{}}%
    \oldchapter{#1}%
}
\let\oldsection\section%
\renewcommand\section[1]{%
    \setcounter{firstParsec}{\value{firstParsecF}/2+1}%
    \addtocontents{parsectoc}{\protect\contentsline{section}{#1}{\sref{parsec-\the\value{firstParsec}.1}}{}}%
    \oldsection{#1}%
}
\let\oldsubsection\subsection%
\renewcommand\subsection[1]{%
    \setcounter{firstParsec}{\value{firstParsecF}/2+1}%
    \addtocontents{parsectoc}{\protect\contentsline{subsection}{#1}{\sref{parsec-\the\value{firstParsec}.1}}{}}%
    \oldsubsection{#1}%
}
\let\oldsubsubsection\subsubsection%
\renewcommand\subsubsection[1]{%
    \setcounter{firstParsec}{\value{firstParsecF}/2+1}%
    \addtocontents{parsectoc}{\protect\contentsline{subsubsection}{#1}{\sref{parsec-\the\value{firstParsec}.1}}{}}%
    \oldsubsubsection{#1}%
}

